<!DOCTYPE html>
<html>
	<head>
		<title>Chalice: the card game</title>
		<script node> getAsset("meta") </script>node>
		<script node> getAsset("google fonts") </script>node>
		<link rel="shortcut icon" type="image/png" href="logo.png"/>
		<link rel="stylesheet" type="text/css" href="./home/stylesheet.css"/>
		<script type="text/javascript" src="./home/script.js"></script>
		<script node>
			/* globals */
				var player = request.session.id       || null
				var round  = request.game.state.round || null
				var turn   = request.game.state.turn  || null
			
			/* buildPerson */
				function buildPerson(person) {
					// cards
						var cardsBlock = '<div class="cards">'
						for (var c = 0; c < person.cards.length; c++) {
							cardsBlock += '<div class="card" face="' + (person.id == player ? "front" : "back") + '" type="" id="' + person.cards[c].id + '">'
								+ '<div class="card-back"></div>'
								+ '<div class="card-front"></div>'
							+ '</div>'
						}
						cardsBlock += '</div>'

					// immunities
						var immunitiesBlock = '<div class="immunities>'
						for (var i = 0; i < person.immunities.length; i++) {
							immunitiesBlock += '<div class="card" face="front" type="' + person.immunities[i].type.replace(/\s/g,"") + '" id="' + person.immunities[i].id + '">'
								+ '<div class="card-back"></div>'
								+ '<div class="card-front"></div>'
							+ '</div>'
						}
						immunitiesBlock += '</div>'

					// cups
						var cupsBlock = '<div class="cups>'
						for (var c = 0; c < person.cups.length; c++) {
							cupsBlock += '<div class="cup" face="' + person.cups[c].face + '" type="" id="' + person.cups[c].id + '">'
								+ '<div class="cup-back"></div>'
								+ '<div class="cup-front"></div>'
							+ '</div>'
						}
						cupsBlock += '</div>'

					// name
						var nameBlock = '<div class="name" ' + (person.id == player ? "contenteditable" : "") + '>'
							+ person.name
						+ '</div>'

					// combined
						var personBlock = '<div class="' + (person.id == player ? "player" : "opponent") + '" turn="' + (turn == person.seat ? "true" : "false") + '" id="' + person.id + '">'
							+ nameBlock
							+ cupsBlock
							+ immunitiesBlock
							+ cardsBlock
						+ '</div>'

					return personBlock || ''
				}

			/* buildTable */
				function buildTable(state, table) {
					var tableBlock = ''

					if (!state.start) {
						tableBlock += '<div id="status">game has not started</div>'
						+ '<div id="active"></div>'
						+ '<div id="prompt"></div>'
						+ '<div class="cups"></div>'
						+ '<div class="cards"></div>'
					}
					else if (state.end) {
						tableBlock += '<div id="status">' + state.victor.name + ' wins!</div>'
						+ '<div id="active"></div>'
						+ '<div id="prompt"></div>'
						+ '<div class="cups"></div>'
						+ '<div class="cards"></div>'
					}
					else if (turn !== player) {
						// active
							var activeBlock = '<div id="active">'
							for (var a in table.active) {
								var card = table.active[a]
								activeBlock += '<div class="card" face="front" type="' + card[a].type.replace(/\s/g,"") + '" id="' + card[a].id + '">'
									+ '<div class="card-back"></div>'
									+ '<div class="card-front"></div>'
								+ '</div>'
							}
							activeBlock += "</div>"

						// table
							tableBlock += '<div id="status">opponent\'s turn</div>'
							+ activeBlock
							+ '<div id="prompt"></div>'
							+ '<div class="cups"></div>'
							+ '<div class="cards"></div>'
					}
					else {
						// active
							var activeBlock = '<div id="active">'
							for (var a in table.active) {
								var card = table.active[a]
								activeBlock += '<div class="card" face="front" type="' + card[a].type.replace(/\s/g,"") + '" id="' + card[a].id + '">'
									+ '<div class="card-back"></div>'
									+ '<div class="card-front"></div>'
								+ '</div>'
							}
							activeBlock += "</div>"

						// cups
							var cupsBlock = '<div class="cups">'
							for (var c in table.cups) {
								var cup = table.cups[c]
								cupsBlock += '<div class="cup" face="front" type="' + cup[c].type.replace(/\s/g,"") + '" id="' + cup[c].id + '">'
									+ '<div class="cup-back"></div>'
									+ '<div class="cup-front"></div>'
								+ '</div>'
							}
							cupsBlock += "</div>"

						// cards
							var cardsBlock += '<div class="cards">'
							for (var c in table.cards) {
								var card = table.cards[c]
								cardsBlock += '<div class="card" face="front" type="' + card[c].type.replace(/\s/g,"") + '" id="' + card[c].id + '">'
									+ '<div class="card-back"></div>'
									+ '<div class="card-front"></div>'
								+ '</div>'
							}
							cardsBlock += "</div>"

						// table
							tableBlock = '<div id="status">your turn</div>'
							+ activeBlock
							+ '<div id="prompt">' + table.prompt + '</div>'
							+ cupsBlock
							+ cardsBlock
					}

					return tableBlock || ''
				}

			/* fetchLoop */
				if (request.game.state.end) { "<script>window.clearLoop = true</script>" }
		</script>node>
	</head>
	<body>
		<div id="background"></div>
		<div id="error" class="hidden"></div>
		<div id="board" round="<script node>round</script>node>" turn="<script node>turn</script>node>" player="<script node>player</script>node>">
			<div id="opponents"><script node>
				var opponentsBlock = ''
				var opponents = Object.keys(request.game.players).filter(function (p) {
					return p !== player
				}) || []

				for (var o in opponents) {
					opponentsBlock += buildPerson(request.game.players[opponents[o]]) || ''
				}
				opponentsBlock || ""
			</script>node></div>
			<div id="table"><script node>
				buildTable(request.game.state, request.game.table) || ""
			</script>node></div>
			<div id="player"><script node>
				var playerBlock = buildPerson(request.game.players[player]) || ''
				playerBlock || ""
			</script>node></div>
		</div>
	</body>
</html>
